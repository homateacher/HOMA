<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>í˜¸ë§ˆë§¨ì˜ ì²´ìœ¡íƒêµ¬ ê·¼ìœ¡ ë¬¸ì œí’€ì´ â€” í™•ì¥ ëœë¤ ë²„ì „</title>
<style>
  :root{
    --bg:#f7fafc; --ink:#111827; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
    --accent:#2563eb; --ok:#16a34a; --bad:#ef4444; --hint:#0ea5e9;
    --fs-base: 16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Pretendard,"Noto Sans KR",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    font-size:var(--fs-base);
    background: radial-gradient(900px 600px at 20% -10%, #e0f2fe 0%, var(--bg) 40%) fixed;
    color:var(--ink); line-height:1.65;
    display:flex; flex-direction:column; align-items:center;
    -webkit-text-size-adjust:100%;
  }
  header{width:100%; max-width:900px; padding:20px 14px 6px}
  h1{margin:0; font-size:clamp(20px,4.6vw,36px); line-height:1.2}
  .app{width:100%; max-width:900px; padding:10px 12px 24px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; margin-top:10px; box-shadow:0 4px 16px rgba(15,23,42,.06)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  button{
    cursor:pointer;border:1px solid var(--border);background:#f8fafc;color:#111827;
    padding:12px 14px;border-radius:12px; font-size:clamp(14px,3.8vw,16px);
    -webkit-tap-highlight-color:transparent; width:auto;
  }
  @media (max-width:560px){ .row button{flex:1 1 100%} }
  button.primary{background:linear-gradient(135deg, rgba(37,99,235,.10), rgba(14,165,233,.10))}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .qnum{font-weight:700;color:#334155}
  .prompt{font-size:clamp(16px,4.4vw,20px);margin:6px 0 10px; word-break:keep-all}
  .options{display:grid;gap:8px}
  @media(min-width:720px){.options{grid-template-columns:1fr 1fr}}
  .opt{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#f9fafb}
  .opt input{margin-top:4px; transform: scale(1.15)}
  .opt span{word-break:keep-all; overflow-wrap:anywhere}
  .opt.correct{border-color:rgba(22,163,74,.7);box-shadow:0 0 0 2px rgba(22,163,74,.18) inset;background:#ecfdf5}
  .opt.wrong{border-color:rgba(239,68,68,.7);box-shadow:0 0 0 2px rgba(239,68,68,.18) inset;background:#fef2f2}
  .meta{display:flex;justify-content:space-between;align-items:center; gap:8px; flex-wrap:wrap}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#0b5394;background:#e0f2fe}
  .explain{margin-top:10px;padding:10px;border-left:3px solid var(--hint);background:#f0f9ff;border-radius:8px; font-size:clamp(13px,3.6vw,14px)}
  .score{font-size:clamp(28px,7vw,40px);font-weight:800;text-align:center;margin:10px 0;color:#0b5394}
  ul{margin:6px 0 0 18px; padding-left:18px}
  .small{font-size:clamp(12px,3.4vw,13px); color:var(--muted)}
  #confettiCanvas{position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:9999;}
  .prompt, .opt span, .explain, .small { word-break: keep-all; overflow-wrap: anywhere; }

  /* âœ¨ Score-based flair */
  .celebrate{ text-align:center; margin-top:8px; }
  .rainbow{
    font-weight:900;
    font-size:clamp(28px,9vw,56px);
    background: linear-gradient(90deg,#ff0048,#ff8a00,#ffd200,#16c60c,#00c3ff,#7a00ff);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    animation: shimmer 2s linear infinite;
  }
  @keyframes shimmer { to { background-position: 200% 0; } }
  .glow90{ font-size:clamp(24px,7.5vw,48px); color:#1d4ed8; text-shadow:0 0 12px rgba(29,78,216,.4)}
  .glow70{ font-size:clamp(22px,6.8vw,42px); color:#0ea5e9; text-shadow:0 0 10px rgba(14,165,233,.35)}
  .glow65{ font-size:clamp(20px,6.4vw,36px); color:#f59e0b; animation: pulse 1.2s ease-in-out infinite }
  .glow60{ font-size:clamp(20px,6vw,34px); color:#ef4444; animation: wobble .9s ease-in-out infinite }
  @keyframes pulse { 0%,100%{ transform:scale(1)} 50%{ transform:scale(1.05)} }
  @keyframes wobble { 0%,100%{ transform:translateX(0) } 25%{ transform:translateX(-2px) } 75%{ transform:translateX(2px) } }
</style>
</head>
<body>
<canvas id="confettiCanvas"></canvas>
<header><h1>í˜¸ë§ˆë§¨ì˜ ì²´ìœ¡íƒêµ¬ ê·¼ìœ¡ ë¬¸ì œí’€ì´</h1></header>

<div class="app">
  <div class="card" id="intro">
    <div class="row">
      <button class="primary" id="startBtn">í€´ì¦ˆ ì‹œì‘ (10ë¬¸í•­)</button>
    </div>
    <p class="small">ê·¼ìœ¡ í•˜ë‚˜ê°€ ì œì‹œë˜ë©´ ë³´ê¸° 4~5ê°œ ì¤‘ <b>í•´ë‹¹ ê·¼ìœ¡ì˜ ê´€ì ˆâ€”ë™ì‘</b>ì„ ê³ ë¥´ì„¸ìš”. ì •ë‹µì´ ì—¬ëŸ¬ ê°œì¼ ë•ŒëŠ” <b>í•˜ë‚˜ë§Œ ê³¨ë¼ë„ ì •ë‹µ</b>ìœ¼ë¡œ ì¸ì •í•©ë‹ˆë‹¤.</p>
  </div>

  <div class="card" id="quiz" style="display:none">
    <div class="meta">
      <div><span class="qnum" id="qIdx">1</span>/10</div>
      <div class="pill" id="typeBadge">ì •ë‹µ 1ê°œ</div>
    </div>
    <div class="prompt" id="prompt">ì—¬ê¸°ì— ë¬¸ì œê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
    <div class="options" id="options"></div>
    <div class="row" style="margin-top:10px">
      <button id="submitBtn" class="primary">ì œì¶œ</button>
      <button id="nextBtn" style="display:none">ë‹¤ìŒ â–¶</button>
      <div class="small" id="feedback"></div>
    </div>
    <div class="explain" id="explain" style="display:none"></div>
  </div>

  <div class="card" id="result" style="display:none">
    <h3 style="margin:0 0 8px">ê²°ê³¼</h3>
    <div class="score" id="score"></div>
    <div id="passMsg" class="celebrate"></div>
    <div class="row" style="justify-content:center; margin-top:10px">
      <button class="primary" onclick="location.reload()">ìƒˆë¡œ ê³ ì¹¨í•˜ì—¬ ìƒˆ ëœë¤ ì„¸íŠ¸ ì‹œì‘</button>
    </div>
    <div class="explain" id="summary" style="margin-top:12px"></div>
  </div>
</div>

<script>
// ===== ê·¼ìœ¡ ë°ì´í„° í™•ì¥ =====
const MUSCLES = [
  {name:"ìŠ¹ëª¨ê·¼(ìƒÂ·ì¤‘Â·í•˜ë¶€)", actions:["ê²¬ê°‘ â€” ê±°ìƒ","ê²¬ê°‘ â€” í•˜ê°•","ê²¬ê°‘ â€” í›„ì¸(ë‚´ì „)","ê²¬ê°‘ â€” ìƒë°©íšŒì „","ê²¬ê°‘ â€” ìƒë°©íšŒì „(ìƒÂ·í•˜ë¶€ í˜‘ì‘)"]},
  {name:"ê´‘ë°°ê·¼", actions:["ì–´ê¹¨ â€” ì‹ ì „","ì–´ê¹¨ â€” ë‚´ì „","ì–´ê¹¨ â€” ë‚´íšŒì „","ê²¬ê°‘ â€” í•˜ê°•(ë³´ì¡°)"]},
  {name:"í–„ìŠ¤íŠ¸ë§(ì „ì²´)", actions:["ë¬´ë¦ â€” êµ´ê³¡","ê³ ê´€ì ˆ â€” ì‹ ì „"]},
  {name:"ëŒ€í‡´ì‚¬ë‘ê·¼", actions:["ë¬´ë¦ â€” ì‹ ì „","ê³ ê´€ì ˆ â€” êµ´ê³¡(ëŒ€í‡´ì§ê·¼)"]},
  {name:"ë¹„ë³µê·¼", actions:["ë°œëª© â€” ì €ì¸¡êµ´ê³¡(ë°œë°”ë‹¥êµ½í˜)","ë¬´ë¦ â€” êµ´ê³¡(ë³´ì¡°)"]},
  {name:"ì „ì™„ê·¼(êµ´ê·¼Â·ì‹ ê·¼)", actions:["ì†ëª© â€” êµ´ê³¡","ì†ëª© â€” ì‹ ì „","ì „ì™„ â€” íšŒë‚´(ì¼ë¶€)","ì „ì™„ â€” íšŒì™¸(ì¼ë¶€)","ì†ê°€ë½ â€” êµ´ê³¡/ì‹ ì „(ì¼ë¶€)"]},
  {name:"ìƒì™„ì´ë‘ê·¼", actions:["íŒ”ê¿ˆì¹˜ â€” êµ´ê³¡","ì „ì™„ â€” íšŒì™¸","ì–´ê¹¨ â€” êµ´ê³¡(ë³´ì¡°)"]},
  {name:"ìƒì™„ì‚¼ë‘ê·¼", actions:["íŒ”ê¿ˆì¹˜ â€” ì‹ ì „","ì–´ê¹¨ â€” ì‹ ì „(ì¥ë‘)","ì–´ê¹¨ â€” ë‚´ì „(ì¥ë‘)"]},
  {name:"ì‚¼ê°ê·¼(ì „Â·ì¤‘Â·í›„ë¶€)", actions:["ì–´ê¹¨ â€” êµ´ê³¡(ì „ë¶€)","ì–´ê¹¨ â€” ì™¸ì „(ì¤‘ë¶€)","ì–´ê¹¨ â€” ì‹ ì „(í›„ë¶€)","ì–´ê¹¨ â€” ë‚´íšŒì „(ì „ë¶€)","ì–´ê¹¨ â€” ì™¸íšŒì „(í›„ë¶€)","ì–´ê¹¨ â€” ìˆ˜í‰ë‚´ì „(ì „ë¶€)","ì–´ê¹¨ â€” ìˆ˜í‰ì™¸ì „(í›„ë¶€)"]},
  {name:"ë³µê·¼(ë³µì§ê·¼ ì¤‘ì‹¬)", actions:["ëª¸í†µ â€” êµ´ê³¡","ê³¨ë°˜ â€” í›„ë°©ê²½ì‚¬"]},
  {name:"ëŒ€ë‘”ê·¼", actions:["ê³ ê´€ì ˆ â€” ì‹ ì „","ê³ ê´€ì ˆ â€” ì™¸íšŒì „","ê³ ê´€ì ˆ â€” ë²Œë¦¼(ìƒë¶€ì„¬ìœ )"]},
  {name:"ì¤‘ë‘”ê·¼", actions:["ê³ ê´€ì ˆ â€” ë²Œë¦¼","ê³ ê´€ì ˆ â€” ë‚´íšŒì „(ì „ì„¬ìœ )","ê³ ê´€ì ˆ â€” ì‹ ì „Â·ì™¸íšŒì „(í›„ì„¬ìœ )","ë³´í–‰ ì‹œ ê³¨ë°˜ ì•ˆì •í™”"]},
  {name:"ì¥ìš”ê·¼", actions:["ê³ ê´€ì ˆ â€” êµ´ê³¡","ê³ ê´€ì ˆ â€” ì™¸íšŒì „(ë³´ì¡°)","ìš”ì¶” â€” ì „ë§Œ ìœ ì§€(ë³´ì¡°)"]},
  {name:"ì „ê±°ê·¼", actions:["ê²¬ê°‘ â€” ì „ì¸(ë²Œë¦¼)","ê²¬ê°‘ â€” ìƒë°©íšŒì „","ê²¬ê°‘ â€” ê³ ì •"]},
  {name:"íšŒì „ê·¼ê°œ(ê·¹ìƒ/ê·¹í•˜/ì†Œì›/ê²¬ê°‘í•˜)", actions:["ì–´ê¹¨ â€” ì™¸ì „(ì´ˆê¸°, ê·¹ìƒê·¼)","ì–´ê¹¨ â€” ì™¸íšŒì „(ê·¹í•˜/ì†Œì›ê·¼)","ì–´ê¹¨ â€” ë‚´íšŒì „(ê²¬ê°‘í•˜ê·¼)","ê²¬ê´€ì ˆ ì•ˆì •í™”"]},
  {name:"ë‚´ì „ê·¼êµ°(ì¥/ë‹¨/ëŒ€ë‚´ì „ê·¼ ë“±)", actions:["ê³ ê´€ì ˆ â€” ë‚´ì „","ê³ ê´€ì ˆ â€” êµ´ê³¡(ë³´ì¡°)","ê³ ê´€ì ˆ â€” ì™¸íšŒì „(ì¼ë¶€)"]},
];

// ì¶”ê°€ì ì¸ 'ì˜¤ë‹µ/êµë€' í’€ì„ ìœ„í•´, ì‹¤ì œë¡œ ì“°ì´ì§€ëŠ” ì•Šì§€ë§Œ ë‹¤ì–‘ì„±ì„ ëŠ˜ë¦´ ìˆ˜ ìˆëŠ” ì¼ë°˜ ë™ì‘ ìš©ì–´
const EXTRA_ACTIONS = [
  "ì–´ê¹¨ â€” ê´€ì ˆ ì¤‘ì‹¬ ì•ˆì •í™”(ë³´ì¡°)",
  "ê²¬ê°‘ â€” í•˜ë°©íšŒì „(ë³´ì¡°)",
  "ëª¸í†µ â€” ì‹ ì „(ë³´ì¡°)",
  "ë¬´ë¦ â€” ì‹ ì „(ë³´ì¡°)",
  "ë°œëª© â€” ë°°ì¸¡êµ´ê³¡(ë³´ì¡°)",
  "ì „ì™„ â€” ì¤‘ë¦½ ìœ ì§€(ë³´ì¡°)",
  "ê³¨ë°˜ â€” ì „ë°©ê²½ì‚¬(ë³´ì¡°)",
  "ê²¬ê°‘ â€” ì „ì¸/í›„ì¸ ì¡°ì ˆ(ë³´ì¡°)"
];

// ì „ì²´ ë³´ê¸° í’€
const ALL_ACTIONS = Array.from(new Set([
  ...MUSCLES.flatMap(m=>m.actions),
  ...EXTRA_ACTIONS
]));

// ===== ìƒíƒœ/ìœ í‹¸ =====
let state = { total: 10, bank: [], idx: 0, correct: 0 };
let audioCtx = null;

function norm(s){
  return String(s)
    .replace(/[\u200B-\u200D\uFEFF]/g,'')          // zero-width
    .replace(/[â€“â€”-]/g,'â€”')                          // unify dashes
    .replace(/[ï¼ˆ]/g,'(').replace(/[ï¼‰]/g,')')       // fullwidth to ascii
    .replace(/\s+/g,' ').replace(/\u00A0/g,' ')     // spaces
    .trim().toLowerCase();
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
function sample(arr,k){ const c=arr.slice(); shuffle(c); return c.slice(0,Math.min(k,c.length)); }
function uniq(arr){ const seen=new Set(); const out=[]; for(const x of arr){ const k=norm(x); if(!seen.has(k)){ seen.add(k); out.push(x);} } return out; }

// ===== ì†Œë¦¬(ì›¹ì˜¤ë””ì˜¤) =====
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}
function beep(freq=880, dur=0.2, type='triangle', vol=0.2, delay=0){
  const ctx = ensureAudio();
  const t0 = ctx.currentTime + delay;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = type; osc.frequency.setValueAtTime(freq, t0);
  gain.gain.setValueAtTime(0.0001, t0);
  gain.gain.exponentialRampToValueAtTime(vol, t0+0.02);
  gain.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
  osc.connect(gain).connect(ctx.destination);
  osc.start(t0); osc.stop(t0 + dur + 0.05);
}
function chord(freqs=[523,659,784], dur=0.5, vol=0.15, delay=0){
  freqs.forEach((f,i)=>beep(f, dur, 'sine', vol, delay + i*0.02));
}
function wrongBuzz(){
  const ctx = ensureAudio();
  const t0 = ctx.currentTime;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type='sawtooth'; osc.frequency.setValueAtTime(180, t0);
  gain.gain.setValueAtTime(0.001, t0);
  gain.gain.exponentialRampToValueAtTime(0.18, t0+0.05);
  gain.gain.exponentialRampToValueAtTime(0.0001, t0+0.35);
  osc.connect(gain).connect(ctx.destination);
  osc.start(t0); osc.stop(t0+0.4);
}
function drumRollAndFanfare(totalScore){
  const ctx = ensureAudio();
  const t0 = ctx.currentTime;
  // drum roll
  const bufferSize = 2 * ctx.sampleRate;
  const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i=0; i<bufferSize; i++){ data[i] = (Math.random()*2 - 1) * (1 - i/bufferSize); }
  const noise = ctx.createBufferSource(); noise.buffer = buffer;
  const band = ctx.createBiquadFilter(); band.type='bandpass'; band.frequency.value=1500; band.Q.value=0.7;
  const gain = ctx.createGain();
  gain.gain.setValueAtTime(0.0001, t0);
  gain.gain.exponentialRampToValueAtTime(0.2, t0+0.2);
  gain.gain.exponentialRampToValueAtTime(0.0001, t0+1.0);
  noise.connect(band).connect(gain).connect(ctx.destination);
  noise.start(t0); noise.stop(t0+1.05);
  // fanfare
  const base = totalScore===100 ? 523 : 440;
  chord([base, base*5/4, base*3/2], 0.7, 0.2, 0.9);
  chord([base*2, base*2*5/4, base*2*3/2], 0.6, 0.15, 1.0);
}

// ===== ì‹œì‘/ë¬¸í•­ ìƒì„± =====
function startQuiz(){
  ensureAudio(); // unlock on user gesture
  state.bank = buildQuestions(state.total).map(q=>ensureCorrectPresent(q));
  state.idx = 0; state.correct = 0;
  document.getElementById('intro').style.display='none';
  document.getElementById('quiz').style.display='block';
  render();
}
function buildQuestions(n){
  const ms = shuffle(MUSCLES.slice());
  const pick = ms.slice(0, Math.min(n, ms.length));
  return pick.map(m => makeMuscleQuestion(m));
}
function makeMuscleQuestion(m){
  const acts = m.actions.slice();
  const k = (acts.length >= 2 && Math.random()<0.5) ? 2 : 1; // ë³µìˆ˜ì •ë‹µ ë¹„ìœ¨ ì‚´ì§ ìƒìŠ¹
  const correctArr = sample(acts, k);
  const correct = new Set(correctArr);
  const optionCount = (Math.random()<0.5 ? 4 : 5);

  // ì •ë‹µ ë¨¼ì € í¬í•¨
  let options = correctArr.slice();

  // ì˜¤ë‹µ í’€ì„ í¬ê²Œ í™•ì¥: ë™ì¼ ê´€ì ˆêµ°/íƒ€ ê´€ì ˆêµ° í˜¼í•©
  const pool = ALL_ACTIONS.filter(a => !correct.has(a));
  // ë™ì¼ ê´€ì ˆ ìš°ì„  ì¶”ì¶œ
  const jointKey = acts[0].split('â€”')[0].trim(); // "ì–´ê¹¨ ", "ê³ ê´€ì ˆ " ë“±
  const sameJoint = pool.filter(a => a.startsWith(jointKey));
  const otherJoint = pool.filter(a => !a.startsWith(jointKey));

  let distractors = uniq([
    ...sample(sameJoint, optionCount * 2),
    ...sample(otherJoint, optionCount * 2)
  ]);

  for(const d of distractors){
    if(options.length >= optionCount) break;
    if(!options.map(norm).includes(norm(d))) options.push(d);
  }
  // ì•„ì§ ë¶€ì¡±í•˜ë©´ ì „ì²´ í’€ì—ì„œ ì±„ìš°ê¸°
  let idx=0;
  while(options.length < optionCount && idx < pool.length){
    const cand = pool[idx++];
    if(!options.map(norm).includes(norm(cand))) options.push(cand);
  }

  options = shuffle(options);
  const explain = `<b>${m.name}</b>ì˜ ëŒ€í‘œ ì‘ìš©<br>â€¢ ${m.actions.join("<br>â€¢ ")}`;
  return { muscle:m.name, options, correct, multi:(k>1), explain };
}
function ensureCorrectPresent(q){
  const correctNorm = new Set([...q.correct].map(norm));
  const has = q.options.some(o => correctNorm.has(norm(o)));
  if(!has){
    const rep = [...q.correct][0];
    if(q.options.length>0) q.options[q.options.length-1] = rep;
    else q.options = [rep];
    q.options = uniq(q.options);
    q.options = shuffle(q.options);
  }
  return q;
}

// ===== ë Œë” & ì±„ì  =====
document.getElementById('startBtn').addEventListener('click', startQuiz);

function render(){
  const q = state.bank[state.idx];
  document.getElementById('qIdx').textContent = state.idx+1;
  document.getElementById('typeBadge').textContent = q.multi ? "ì •ë‹µ ì—¬ëŸ¬ ê°œ(í•˜ë‚˜ë§Œ ê³¨ë¼ë„ ì •ë‹µ)" : "ì •ë‹µ 1ê°œ";
  const prompt = document.getElementById('prompt');
  const optWrap = document.getElementById('options'); optWrap.innerHTML='';

  prompt.innerHTML = `ê·¼ìœ¡: <b>${q.muscle}</b><br><span class="small">í•´ë‹¹ ê·¼ìœ¡ì´ ë‹´ë‹¹í•˜ëŠ” <b>ê´€ì ˆ â€” ë™ì‘</b>ì„ ${q.multi? "í•˜ë‚˜ ì´ìƒ": "í•˜ë‚˜"} ê³ ë¥´ì„¸ìš”.</span>`;

  q.options.forEach((txt)=>{
    const div = document.createElement('label'); div.className='opt';
    const inp = document.createElement('input'); inp.type='checkbox'; inp.name='opt'; inp.value=txt;
    inp.addEventListener('change', ()=>{ if(!q.multi){ document.querySelectorAll('input[name="opt"]').forEach(el=>{ if(el!==inp) el.checked=false; }); } });
    const span = document.createElement('span'); span.textContent = txt;
    div.appendChild(inp); div.appendChild(span); optWrap.appendChild(div);
  });

  document.getElementById('feedback').textContent='';
  document.getElementById('explain').style.display='none';
  document.getElementById('submitBtn').style.display='inline-flex';
  document.getElementById('nextBtn').style.display='none';
}

document.getElementById('submitBtn').addEventListener('click', ()=>{
  const q = state.bank[state.idx];
  const chosen = Array.from(document.querySelectorAll('input[name="opt"]:checked')).map(x=>x.value);
  if(chosen.length===0){ alert('í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  const chosenNorm = new Set(chosen.map(norm));
  const correctNorm = new Set([...q.correct].map(norm));

  let isCorrect = false;
  if(!q.multi){
    isCorrect = (chosenNorm.size===1) && correctNorm.has([...chosenNorm][0]);
  }else{
    isCorrect = [...chosenNorm].every(x=>correctNorm.has(x)); // ë¶€ë¶„ì •ë‹µ ì¸ì •
  }
  if(isCorrect) state.correct++;

  document.querySelectorAll('.opt').forEach(div=>{
    const val = norm(div.querySelector('input').value);
    const isTrue = correctNorm.has(val);
    const picked = chosenNorm.has(val);
    if(isTrue) div.classList.add('correct');
    if(picked && !isTrue) div.classList.add('wrong');
    div.querySelector('input').disabled = true;
  });

  document.getElementById('feedback').textContent = isCorrect ? "ì •ë‹µ! ì˜í–ˆì–´ìš” ğŸ‘" : "ì˜¤ë‹µ ğŸ˜… ì •ë‹µ í‘œì‹œë¥¼ í™•ì¸í•˜ì„¸ìš”.";
  const ex = document.getElementById('explain'); ex.innerHTML = q.explain; ex.style.display='block';
  document.getElementById('submitBtn').style.display='none';
  document.getElementById('nextBtn').style.display='inline-flex';

  if(isCorrect){ 
    // fun sound & small confetti
    beep(1046,0.15,'triangle',0.15,0);
    beep(1318,0.15,'triangle',0.12,0.12);
    beep(1568,0.2,'triangle',0.10,0.22);
    triggerConfetti(1);
  } else {
    wrongBuzz();
  }
});

document.getElementById('nextBtn').addEventListener('click', ()=>{
  state.idx++;
  if(state.idx >= state.total){ showResult(); }
  else { render(); }
});

function showResult(){
  document.getElementById('quiz').style.display='none';
  document.getElementById('result').style.display='block';
  const points = state.correct * 10; // 1ë¬¸ì œ=10ì 
  const pct = Math.round(100*state.correct/state.total);
  document.getElementById('score').textContent = `ì •ë‹µ ${state.correct} / ${state.total} â†’ ${points}ì  (${pct}%)`;

  const msgEl = document.getElementById('passMsg');
  if(points === 100){
    msgEl.className = 'celebrate rainbow';
    msgEl.innerHTML = "ğŸ† ë‹¹ì‹ ì€ ê·¼ìœ¡ ë§ˆìŠ¤í„°!!!! ğŸ†<br>í™˜ìƒì ì¸ ì§‘ì¤‘ë ¥ê³¼ ê¸°ì–µë ¥ìœ¼ë¡œ ì™„ë²½ ì •ë³µ! ğŸ’ªğŸ‰ğŸ”¥";
  } else if(points >= 90){
    msgEl.className = 'celebrate glow90';
    msgEl.innerHTML = "ğŸŒŸ ê±°ì˜ ì™„ë²½! ê·¼ìœ¡ ë°•ì‚¬ ê·¼ì²˜ê¹Œì§€ ì™”ì–´ìš”! ì¡°ê¸ˆë§Œ ë” ê°€ë©´ ë§ˆìŠ¤í„°! ğŸ‘ğŸ‘";
  } else if(points >= 70){
    msgEl.className = 'celebrate glow70';
    msgEl.innerHTML = "ğŸ¯ ì¢‹ì•„ìš”! ê¸°ë³¸ê¸°ë¥¼ í™•ì‹¤íˆ ë‹¤ì¡Œì–´ìš”. ì˜ì§„ìŒ¤ê»˜ ìë‘ìŠ¤ëŸ½ê²Œ ë³´ì—¬ì£¼ì„¸ìš”! ğŸ’™";
  } else if(points >= 61){
    msgEl.className = 'celebrate glow65';
    msgEl.innerHTML = "âš¡ í•œ ê±¸ìŒë§Œ ë”! ê³§ 70ì  ëŒíŒŒ! ë‹¤ì‹œ ë„ì „í•´ë³¼ê¹Œìš”? ğŸ”¥";
  } else {
    msgEl.className = 'celebrate glow60';
    msgEl.innerHTML = "ğŸ’¥ ì•„ì§ ê·¼ìœ¡ì´ ê¹¨ì–´ë‚˜ì§€ ì•Šì•˜ì–´ìš”! ë‹¤ì‹œ í’€ì–´ì„œ <b>70ì  ì´ìƒ</b> ë§ì„ ë•Œê¹Œì§€ ë„ì „! í™”ì´íŒ…!! ğŸ’ªğŸ”¥";
  }

  drumRollAndFanfare(points);
  const mult = (points===100) ? 2 : 1.3;
  triggerConfetti(mult);

  const items = state.bank.map((q,i)=>{
    const correctList = [...q.correct].join(", ");
    return `<li><b>${i+1}. ${q.muscle}</b> â€” ì •ë‹µ: ${correctList}</li>`;
  }).join("");
  document.getElementById('summary').innerHTML = `<b>ì •ë‹µ í•´ì„¤</b><ul>${items}</ul>`;
}

// ===== ì¶•í•˜ ì½˜í˜í‹° =====
const confettiCanvas = document.getElementById('confettiCanvas');
const ctx = confettiCanvas.getContext('2d');
function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas); resizeCanvas();
let confettiParticles = [];
function createConfetti(x,y,count=80){
  for(let i=0;i<count;i++){
    confettiParticles.push({
      x, y,
      vx: (Math.random()-0.5)*9,
      vy: (Math.random()-1.5)*9,
      size: Math.random()*6+4,
      color: `hsl(${Math.floor(Math.random()*360)},80%,60%)`,
      life: 110 + Math.random()*50
    });
  }
}
function updateConfetti(){
  ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  let alive = [];
  for(const p of confettiParticles){
    p.x += p.vx; p.y += p.vy; p.vy += 0.22; p.life -= 1;
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, p.size, p.size*0.6);
    if(p.life>0 && p.y < confettiCanvas.height+60) alive.push(p);
  }
  confettiParticles = alive;
  if(confettiParticles.length>0) requestAnimationFrame(updateConfetti);
}
function triggerConfetti(mult=1){
  const bursts = Math.max(1, Math.floor(3*mult));
  for(let b=0;b<bursts;b++){
    const x = window.innerWidth/2 + (Math.random()-0.5)*250;
    const y = window.innerHeight/3 + (Math.random()-0.5)*100;
    createConfetti(x,y, Math.floor(80*mult));
  }
  updateConfetti();
}
</script>
</body>
</html>
